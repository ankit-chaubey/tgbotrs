name: üîÑ Auto-Regenerate from Telegram API Spec

on:
  # Run daily at 08:00 UTC to check for new API releases
  schedule:
    - cron: '0 8 * * *'

  # Allow manual trigger with optional version override
  workflow_dispatch:
    inputs:
      force_regenerate:
        description: 'Force regeneration even if spec has not changed'
        required: false
        default: 'false'
        type: boolean
      spec_commit:
        description: 'Specific spec commit SHA to use (leave empty for latest)'
        required: false
        default: ''

  # Also run on pushes to the spec pin file
  push:
    paths:
      - 'spec_commit'

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  SPEC_REPO: ankit-chaubey/api-spec
  SPEC_FILE: api.json
  CODEGEN_SCRIPT: codegen/codegen.py
  OUT_DIR: tgbotrs/src

jobs:
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Step 1: Check if the spec has changed since last run
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  check-for-updates:
    name: üîç Check for API Updates
    runs-on: ubuntu-latest
    outputs:
      has_update: ${{ steps.compare.outputs.has_update }}
      new_version: ${{ steps.fetch-spec.outputs.version }}
      new_date: ${{ steps.fetch-spec.outputs.release_date }}
      new_commit: ${{ steps.fetch-spec.outputs.commit }}
      old_version: ${{ steps.compare.outputs.old_version }}
      spec_changed: ${{ steps.compare.outputs.spec_changed }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Determine spec commit to use
        id: resolve-commit
        run: |
          if [ -n "${{ github.event.inputs.spec_commit }}" ]; then
            COMMIT="${{ github.event.inputs.spec_commit }}"
            echo "Using manually specified commit: $COMMIT"
          else
            COMMIT=$(curl -s "https://api.github.com/repos/${{ env.SPEC_REPO }}/commits?page=1&per_page=1" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" | \
              python3 -c "import json,sys; data=json.load(sys.stdin); print(data[0]['sha'])")
            echo "Latest commit: $COMMIT"
          fi
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT

      - name: Fetch latest API spec
        id: fetch-spec
        run: |
          COMMIT="${{ steps.resolve-commit.outputs.commit }}"
          URL="https://raw.githubusercontent.com/${{ env.SPEC_REPO }}/${COMMIT}/api.json"
          echo "Fetching spec from: $URL"
          curl -sSf "$URL" -o /tmp/api_latest.json
          
          VERSION=$(python3 -c "import json; d=json.load(open('/tmp/api_latest.json')); print(d['version'])")
          DATE=$(python3 -c "import json; d=json.load(open('/tmp/api_latest.json')); print(d['release_date'])")
          TYPES=$(python3 -c "import json; d=json.load(open('/tmp/api_latest.json')); print(len(d['types']))")
          METHODS=$(python3 -c "import json; d=json.load(open('/tmp/api_latest.json')); print(len(d['methods']))")
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "release_date=$DATE" >> $GITHUB_OUTPUT
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT
          echo "types=$TYPES" >> $GITHUB_OUTPUT
          echo "methods=$METHODS" >> $GITHUB_OUTPUT
          
          echo "üì¶ Spec: $VERSION ($DATE) ‚Äî $TYPES types, $METHODS methods"

      - name: Read current pinned version
        id: current-version
        run: |
          if [ -f "api.json" ]; then
            OLD_VERSION=$(python3 -c "import json; d=json.load(open('api.json')); print(d['version'])")
            OLD_DATE=$(python3 -c "import json; d=json.load(open('api.json')); print(d['release_date'])")
            echo "version=$OLD_VERSION" >> $GITHUB_OUTPUT
            echo "release_date=$OLD_DATE" >> $GITHUB_OUTPUT
            echo "Current pinned version: $OLD_VERSION ($OLD_DATE)"
          else
            echo "version=none" >> $GITHUB_OUTPUT
            echo "release_date=none" >> $GITHUB_OUTPUT
            echo "No current api.json found"
          fi

      - name: Compare specs
        id: compare
        run: |
          OLD="${{ steps.current-version.outputs.version }}"
          NEW="${{ steps.fetch-spec.outputs.version }}"
          FORCE="${{ github.event.inputs.force_regenerate }}"
          
          echo "old_version=$OLD" >> $GITHUB_OUTPUT
          
          if [ "$OLD" != "$NEW" ] || [ "$FORCE" = "true" ]; then
            echo "has_update=true" >> $GITHUB_OUTPUT
            echo "spec_changed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Update detected: $OLD ‚Üí $NEW"
          else
            echo "has_update=false" >> $GITHUB_OUTPUT
            echo "spec_changed=false" >> $GITHUB_OUTPUT
            echo "‚úîÔ∏è No update needed (already on $NEW)"
          fi

      # Copy latest spec for use in subsequent jobs
      - name: Upload latest spec as artifact
        if: steps.compare.outputs.has_update == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: api-spec-latest
          path: /tmp/api_latest.json
          retention-days: 1

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Step 2: Run codegen and compute full diff report
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  regenerate:
    name: üîß Regenerate Library
    runs-on: ubuntu-latest
    needs: check-for-updates
    if: needs.check-for-updates.outputs.has_update == 'true'
    outputs:
      added_types: ${{ steps.diff.outputs.added_types }}
      removed_types: ${{ steps.diff.outputs.removed_types }}
      added_methods: ${{ steps.diff.outputs.added_methods }}
      removed_methods: ${{ steps.diff.outputs.removed_methods }}
      changed_types: ${{ steps.diff.outputs.changed_types }}
      changed_methods: ${{ steps.diff.outputs.changed_methods }}
      pr_title: ${{ steps.pr-info.outputs.title }}
      pr_body: ${{ steps.pr-info.outputs.body }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Download latest spec
        uses: actions/download-artifact@v4
        with:
          name: api-spec-latest
          path: /tmp

      - name: Copy current spec for diffing
        run: |
          cp api.json /tmp/api_old.json || echo '{}' > /tmp/api_old.json

      - name: Run diff analysis
        id: diff
        run: |
          python3 .github/scripts/diff_spec.py \
            /tmp/api_old.json \
            /tmp/api_latest.json \
            /tmp/diff_report.json
          
          # Export individual counts to outputs
          ADDED_TYPES=$(python3 -c "import json; d=json.load(open('/tmp/diff_report.json')); print(len(d['added_types']))")
          REMOVED_TYPES=$(python3 -c "import json; d=json.load(open('/tmp/diff_report.json')); print(len(d['removed_types']))")
          ADDED_METHODS=$(python3 -c "import json; d=json.load(open('/tmp/diff_report.json')); print(len(d['added_methods']))")
          REMOVED_METHODS=$(python3 -c "import json; d=json.load(open('/tmp/diff_report.json')); print(len(d['removed_methods']))")
          CHANGED_TYPES=$(python3 -c "import json; d=json.load(open('/tmp/diff_report.json')); print(len(d['changed_types']))")
          CHANGED_METHODS=$(python3 -c "import json; d=json.load(open('/tmp/diff_report.json')); print(len(d['changed_methods']))")
          
          echo "added_types=$ADDED_TYPES" >> $GITHUB_OUTPUT
          echo "removed_types=$REMOVED_TYPES" >> $GITHUB_OUTPUT
          echo "added_methods=$ADDED_METHODS" >> $GITHUB_OUTPUT
          echo "removed_methods=$REMOVED_METHODS" >> $GITHUB_OUTPUT
          echo "changed_types=$CHANGED_TYPES" >> $GITHUB_OUTPUT
          echo "changed_methods=$CHANGED_METHODS" >> $GITHUB_OUTPUT
          
          echo "üìä Diff: +$ADDED_TYPES types, -$REMOVED_TYPES types, +$ADDED_METHODS methods, -$REMOVED_METHODS methods"

      - name: Generate new code
        run: |
          cp /tmp/api_latest.json api.json
          python3 ${{ env.CODEGEN_SCRIPT }} api.json ${{ env.OUT_DIR }}

      - name: Validate generated code
        run: |
          python3 .github/scripts/validate_generated.py \
            api.json \
            ${{ env.OUT_DIR }}/gen_types.rs \
            ${{ env.OUT_DIR }}/gen_methods.rs

      - name: Build PR title and body
        id: pr-info
        run: |
          python3 .github/scripts/build_pr_body.py \
            /tmp/diff_report.json \
            "${{ needs.check-for-updates.outputs.old_version }}" \
            "${{ needs.check-for-updates.outputs.new_version }}" \
            "${{ needs.check-for-updates.outputs.new_date }}" \
            "${{ needs.check-for-updates.outputs.new_commit }}" \
            /tmp/pr_title.txt \
            /tmp/pr_body.md
          
          TITLE=$(cat /tmp/pr_title.txt)
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          
          # GitHub outputs have size limits, use file for the body
          echo "body_file=/tmp/pr_body.md" >> $GITHUB_OUTPUT

      - name: Update spec_commit pin file
        run: echo "${{ needs.check-for-updates.outputs.new_commit }}" > spec_commit

      - name: Commit and push to branch
        id: push
        run: |
          BRANCH="bot-api-update/${{ needs.check-for-updates.outputs.new_version }}"
          BRANCH=$(echo "$BRANCH" | tr ' ' '-' | tr '/' '-')
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git checkout -b "$BRANCH" 2>/dev/null || git checkout "$BRANCH"
          
          git add api.json spec_commit \
            ${{ env.OUT_DIR }}/gen_types.rs \
            ${{ env.OUT_DIR }}/gen_methods.rs
          
          git commit -m "chore(codegen): update to ${{ needs.check-for-updates.outputs.new_version }}

Auto-generated from Telegram Bot API spec commit ${{ needs.check-for-updates.outputs.new_commit }}

Changes:
- Added types: ${{ steps.diff.outputs.added_types || 0 }}
- Removed types: ${{ steps.diff.outputs.removed_types || 0 }}
- Added methods: ${{ steps.diff.outputs.added_methods || 0 }}
- Removed methods: ${{ steps.diff.outputs.removed_methods || 0 }}
"
          
          git push origin "$BRANCH" --force
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: Create or update pull request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="${{ steps.push.outputs.branch }}"
          TITLE="${{ steps.pr-info.outputs.title }}"
          # Try to create; if PR already exists, update it instead
          gh pr create \
            --base main \
            --head "$BRANCH" \
            --title "$TITLE" \
            --body-file /tmp/pr_body.md \
            --label "bot-api-update" \
            --label "auto-generated" \
            --assignee ankit-chaubey \
          || gh pr edit "$BRANCH" \
            --title "$TITLE" \
            --body-file /tmp/pr_body.md

      - name: Upload diff report artifact
        uses: actions/upload-artifact@v4
        with:
          name: diff-report
          path: /tmp/diff_report.json
          retention-days: 7

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # Step 3: Post a summary issue if major changes detected
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  post-summary:
    name: üì¢ Post Update Summary
    runs-on: ubuntu-latest
    needs: [check-for-updates, regenerate]
    if: needs.check-for-updates.outputs.has_update == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download diff report
        uses: actions/download-artifact@v4
        with:
          name: diff-report
          path: /tmp

      - name: Post to GitHub summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ü§ñ Telegram Bot API Update Detected!
          EOF
          
          python3 - << 'PYEOF'
          import json, os

          report = json.load(open('/tmp/diff_report.json'))
          summary = open(os.environ['GITHUB_STEP_SUMMARY'], 'a')

          old_v = "${{ needs.check-for-updates.outputs.old_version }}"
          new_v = "${{ needs.check-for-updates.outputs.new_version }}"
          new_d = "${{ needs.check-for-updates.outputs.new_date }}"

          summary.write(f"\n**{old_v}** ‚Üí **{new_v}** ({new_d})\n\n")

          def section(title, items, emoji):
              if not items:
                  return
              summary.write(f"### {emoji} {title} ({len(items)})\n")
              for item in items[:30]:
                  summary.write(f"- `{item}`\n")
              if len(items) > 30:
                  summary.write(f"- ...and {len(items)-30} more\n")
              summary.write("\n")

          section("New Types", report['added_types'], "‚úÖ")
          section("Removed Types", report['removed_types'], "‚ùå")
          section("New Methods", report['added_methods'], "‚úÖ")
          section("Removed Methods", report['removed_methods'], "‚ùå")

          if report['changed_types']:
              summary.write(f"### üîÑ Changed Types ({len(report['changed_types'])})\n")
              for name, changes in list(report['changed_types'].items())[:20]:
                  summary.write(f"#### `{name}`\n")
                  for field, change in changes.items():
                      summary.write(f"  - **{field}**: {change}\n")
              summary.write("\n")

          if report['changed_methods']:
              summary.write(f"### üîÑ Changed Methods ({len(report['changed_methods'])})\n")
              for name, changes in list(report['changed_methods'].items())[:20]:
                  summary.write(f"#### `{name}`\n")
                  for field, change in changes.items():
                      summary.write(f"  - **{field}**: {change}\n")
              summary.write("\n")

          PYEOF
