name: ðŸš€ Release â€” Publish to crates.io

on:
  # Trigger when a bot-api-update PR is merged into main
  pull_request:
    types: [closed]
    branches: [main]

  # Or trigger manually
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options: [patch, minor, major]
      dry_run:
        description: 'Dry run (do not actually publish)'
        required: false
        default: 'true'
        type: boolean

permissions:
  contents: write
  pull-requests: read

jobs:
  release:
    name: ðŸ“¦ Version Bump & Publish
    runs-on: ubuntu-latest
    # Only proceed if it's an auto-generated PR being merged, or manual dispatch
    if: >-
      github.event_name == 'workflow_dispatch' ||
      (github.event.pull_request.merged == true &&
       contains(github.event.pull_request.labels.*.name, 'bot-api-update'))

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install cargo-edit (for version bumping)
        run: cargo install cargo-edit --locked

      - name: Determine version bump type
        id: bump-type
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            BUMP="${{ github.event.inputs.bump }}"
          else
            # For auto-updates: check if there are removed/breaking changes â†’ minor, else â†’ patch
            REMOVED_TYPES=$(python3 -c "
          import json
          try:
              r = json.load(open('/tmp/diff_report.json'))
              print(len(r.get('removed_types', [])) + len(r.get('removed_methods', [])))
          except:
              print(0)
          " 2>/dev/null || echo "0")
            
            if [ "$REMOVED_TYPES" -gt "0" ]; then
              BUMP="minor"
            else
              BUMP="patch"
            fi
          fi
          echo "bump=$BUMP" >> $GITHUB_OUTPUT
          echo "Bumping version: $BUMP"

      - name: Read current version
        id: current-ver
        run: |
          VER=$(grep '^version' tgbotrs/Cargo.toml | head -1 | sed 's/version = "//;s/"//')
          echo "version=$VER" >> $GITHUB_OUTPUT
          echo "Current version: $VER"

      - name: Bump version
        id: new-ver
        run: |
          cd tgbotrs
          cargo set-version --bump ${{ steps.bump-type.outputs.bump }}
          VER=$(grep '^version' Cargo.toml | head -1 | sed 's/version = "//;s/"//')
          echo "version=$VER" >> $GITHUB_OUTPUT
          echo "New version: $VER"

      - name: Get API version from spec
        id: api-ver
        run: |
          VER=$(python3 -c "import json; print(json.load(open('api.json'))['version'])")
          echo "version=$VER" >> $GITHUB_OUTPUT

      - name: Update CHANGELOG
        run: |
          API_VER="${{ steps.api-ver.outputs.version }}"
          CRATE_VER="${{ steps.new-ver.outputs.version }}"
          DATE=$(date +%Y-%m-%d)
          
          python3 .github/scripts/update_changelog.py \
            CHANGELOG.md \
            "$CRATE_VER" \
            "$API_VER" \
            "$DATE"

      - name: Build and test before release
        run: cargo test --workspace

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add tgbotrs/Cargo.toml CHANGELOG.md
          git commit -m "chore(release): bump version to ${{ steps.new-ver.outputs.version }}

Telegram Bot API: ${{ steps.api-ver.outputs.version }}
Crate version: ${{ steps.new-ver.outputs.version }}
"
          git push origin main

      - name: Create git tag
        run: |
          TAG="v${{ steps.new-ver.outputs.version }}"
          git tag -a "$TAG" -m "Release $TAG â€” Telegram Bot API ${{ steps.api-ver.outputs.version }}"
          git push origin "$TAG"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.new-ver.outputs.version }}
          name: "v${{ steps.new-ver.outputs.version }} â€” Telegram Bot API ${{ steps.api-ver.outputs.version }}"
          body_path: /tmp/release_notes.md
          generate_release_notes: true
          draft: false

      - name: Publish to crates.io
        if: github.event.inputs.dry_run != 'true'
        run: |
          cd tgbotrs
          cargo publish --token ${{ secrets.CRATES_IO_TOKEN }}
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}

      - name: Dry run publish check
        if: github.event.inputs.dry_run == 'true'
        run: |
          cd tgbotrs
          cargo publish --dry-run
          echo "âœ… Dry run successful - would have published v${{ steps.new-ver.outputs.version }}"
